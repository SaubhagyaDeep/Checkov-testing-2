name: Run scans twice monthly
on:
  schedule:
    - cron: "30 4 1,15 * *" # 1st and 15th of every month at 10:00 AM IST
  workflow_dispatch:

jobs:
  checkov-scan:
    name: Checkov IaC Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: |
          pip install checkov

      - name: Run Checkov scan on common
        run: |
          checkov \
            --directory terraform/common \
            --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,checkov-report-common.sarif \
            --download-external-modules true \
            --check "CKV_GCP*" \
            --quiet \
            --soft-fail

      - name: Run Checkov scan on environment
        run: |
          checkov \
            --directory terraform/environments/ \
            --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,checkov-report-environments.sarif \
            --download-external-modules true \
            --check "CKV_GCP*" \
            --quiet \
            --soft-fail

      - name: Run Checkov scan on  modules
        run: |
          checkov \
            --directory terraform/modules \
            --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,checkov-report-modules.sarif \
            --download-external-modules true \
            --check "CKV_GCP*" \
            --quiet \
            --soft-fail

      - name: Upload SARIF results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-report-common.sarif

      - name: Upload SARIF results for environments
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-report-environments.sarif

      - name: Upload SARIF results for modules
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov-report-modules.sarif

      - name: Upload Checkov results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: checkov-report
          path: |
            checkov-report-common.sarif
            checkov-report-environments.sarif
            checkov-report-modules.sarif
